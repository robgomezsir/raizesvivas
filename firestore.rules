rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ==============================
    // üîß Fun√ß√µes auxiliares
    // ==============================

    // Garante que o usu√°rio est√° autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // ==============================
    // üì© Cole√ß√£o: access_requests (pedidos de convite)
    // ==============================
    match /access_requests/{requestId} {
      // CRIA√á√ÉO: permitir para qualquer usu√°rio (n√£o autenticado) com valida√ß√£o de shape
      allow create: if request.time != null && validarAccessRequest();

      // LEITURA/LISTA: apenas ADMIN S√äNIOR com queries eficientes
      allow read, list: if isAdminSenior() && isEfficientQuery();

      // UPDATE/DELETE: apenas ADMIN S√äNIOR
      allow update, delete: if isAdminSenior();

      function validarAccessRequest() {
        let dados = request.resource.data;
        return dados.keys().hasAll(['email', 'criadoEm', 'status']) &&
               dados.email is string &&
               dados.email.size() > 3 &&
               dados.criadoEm is timestamp &&
               dados.status is string &&
               // Campos opcionais com tipos controlados
               (!dados.keys().hasAny(['nome']) || dados.nome == null || dados.nome is string) &&
               (!dados.keys().hasAny(['telefone']) || dados.telefone == null || dados.telefone is string);
      }
    }

    // ==============================
    // üìä Cole√ß√£o: analytics_notificacoes
    // ==============================
    match /analytics_notificacoes/{eventId} {
      // LEITURA: Apenas ADMIN S√äNIOR pode consultar eventos (com queries eficientes)
      allow read, list: if isAdminSenior() && isEfficientQuery();

      // CRIA√á√ÉO: Qualquer usu√°rio autenticado pode registrar um evento pr√≥prio
      // (n√£o bloqueamos o campo usuarioId por compatibilidade, mas exigimos estar autenticado)
      allow create: if isAuthenticated() && validarEventoAnalytics();

      // Atualiza√ß√£o/Exclus√£o: bloqueado
      allow update, delete: if false;

      function validarEventoAnalytics() {
        let dados = request.resource.data;
        return dados.keys().hasAll(['usuarioId', 'notificacaoId', 'evento', 'criadoEm']) &&
               dados.usuarioId is string &&
               dados.usuarioId.size() > 0 &&
               dados.notificacaoId is string &&
               dados.notificacaoId.size() > 0 &&
               dados.evento is string &&
               dados.evento.size() > 0 &&
               dados.criadoEm is timestamp &&
               // extras s√£o opcionais e, se presentes, precisam ser map
               (!dados.keys().hasAny(['versao']) || dados.versao is string) &&
               (!dados.keys().hasAny(['downloadUrl']) || dados.downloadUrl is string);
      }
    }

    // Verifica se o usu√°rio √© administrador
    function isAdmin() {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.ehAdministrador == true;
    }

    // Verifica se o usu√°rio √© administrador s√™nior
    function isAdminSenior() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.ehAdministradorSenior == true;
    }

    // Verifica se o usu√°rio √© o dono de um documento
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Valida documento de fam√≠lia personalizada (mantida do original)
    function isValidFamiliaPersonalizada(data, familiaId) {
      return data.keys().hasOnly([
               'familiaId',
               'nome',
               'conjuguePrincipalId',
               'conjugueSecundarioId',
               'ehFamiliaZero',
               'atualizadoPor',
               'atualizadoEm'
             ]) &&
             data.familiaId == familiaId &&
             data.nome is string &&
             data.nome.size() > 0 &&
             data.ehFamiliaZero is bool &&
             (!data.keys().hasAny(['conjuguePrincipalId']) || data.conjuguePrincipalId == null || data.conjuguePrincipalId is string) &&
             (!data.keys().hasAny(['conjugueSecundarioId']) || data.conjugueSecundarioId == null || data.conjugueSecundarioId is string) &&
             (!data.keys().hasAny(['atualizadoPor']) || data.atualizadoPor == null || data.atualizadoPor is string) &&
             data.atualizadoEm is timestamp;
    }

    // üîí Fun√ß√£o para limitar consultas grandes e sem ordena√ß√£o
    // Evita que usu√°rios fa√ßam queries sem filtro ou que tragam milhares de documentos
    // Economiza custos e melhora performance
    function isEfficientQuery() {
      return (request.query.limit <= 100) && (request.query.orderBy.size() > 0);
    }

    // ==============================
    // üë§ Cole√ß√£o: users
    // ==============================
    match /users/{userId} {
      allow read: if isAuthenticated(); // todos podem ver perfis (mantido)
      
      // CRIA√á√ÉO: Permitir que usu√°rio crie seu pr√≥prio documento durante cadastro
      // Valida√ß√£o: userId deve ser o mesmo do auth.uid e dados devem ser v√°lidos
      allow create: if isAuthenticated() &&
                     request.auth.uid == userId &&
                     validarUsuarioNovo();
      
      // Atualiza√ß√µes: dono pode manter seu perfil; ADMIN pode administrar
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
      
      // Fun√ß√£o para validar dados de usu√°rio novo
      function validarUsuarioNovo() {
        let dados = request.resource.data;
        return dados.keys().hasAll(['nome', 'email', 'ehAdministrador', 'ehAdministradorSenior', 'primeiroAcesso', 'criadoEm']) &&
               dados.nome is string &&
               dados.nome.size() > 0 &&
               dados.email is string &&
               dados.email.size() > 0 &&
               dados.ehAdministrador is bool &&
               dados.ehAdministradorSenior is bool &&
               dados.primeiroAcesso is bool &&
               dados.criadoEm is timestamp &&
               // Campos opcionais com tipos controlados
               (!dados.keys().hasAny(['fotoUrl']) || dados.fotoUrl == null || dados.fotoUrl is string) &&
               (!dados.keys().hasAny(['posicaoRanking']) || dados.posicaoRanking == null || dados.posicaoRanking is int) &&
               (!dados.keys().hasAny(['pessoaVinculada']) || dados.pessoaVinculada == null || dados.pessoaVinculada is string) &&
               (!dados.keys().hasAny(['familiaZeroPai']) || dados.familiaZeroPai == null || dados.familiaZeroPai is string) &&
               (!dados.keys().hasAny(['familiaZeroMae']) || dados.familiaZeroMae == null || dados.familiaZeroMae is string);
      }
    }

    // ==============================
    // üë§ Cole√ß√£o: usuarios (NOVA ESTRUTURA - Gamifica√ß√£o)
    // ==============================
    match /usuarios/{userId} {
      allow read: if isAuthenticated(); // todos podem ver perfis
      
      // CRIA√á√ÉO: Permitir que usu√°rio crie seu pr√≥prio documento durante cadastro
      allow create: if isAuthenticated() &&
                     request.auth.uid == userId;
      
      // Atualiza√ß√µes: 
      // - Dono pode atualizar apenas o campo posicaoRanking
      // - ADMIN pode atualizar qualquer campo
      allow update: if isAuthenticated() && (
                      // Dono pode atualizar apenas posicaoRanking
                      (isOwner(userId) && 
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['posicaoRanking']) &&
                       (!request.resource.data.keys().hasAny(['posicaoRanking']) || request.resource.data.posicaoRanking == null || request.resource.data.posicaoRanking is int)) ||
                      // Admin pode atualizar qualquer campo
                      isAdmin()
                    );
      
      allow delete: if isAdmin();
    }

    // ==============================
    // üßç Cole√ß√£o: people
    // ==============================
    match /people/{pessoaId} {
      allow list: if isAuthenticated() && isEfficientQuery(); // üîπ impede listagens amplas
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                     request.resource.data.keys().hasAll(['nome', 'criadoPor', 'criadoEm']);
      allow update: if isAuthenticated() &&
                     (isAdmin() ||
                      request.resource.data.criadoPor == request.auth.uid ||
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.pessoaVinculada == pessoaId);
      allow delete: if isAdmin();
    }

    // ==============================
    // üë™ Cole√ß√£o: familia_zero
    // ==============================
    match /familia_zero/{familiaId} {
      allow list: if isAuthenticated() && isEfficientQuery();
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                     request.resource.data.fundadoPor == request.auth.uid &&
                     request.resource.data.locked == true;
      allow update, delete: if isAdmin();
    }

    // ==============================
    // üß¨ Cole√ß√£o: familias_personalizadas
    // ==============================
    match /familias_personalizadas/{familiaId} {
      allow list: if isAdmin() && isEfficientQuery();
      allow read: if isAuthenticated();
      allow create, update: if isAdmin() &&
                             isValidFamiliaPersonalizada(request.resource.data, familiaId);
      allow delete: if isAdmin();
    }

    // ==============================
    // ‚úâÔ∏è Cole√ß√£o: invites
    // ==============================
    match /invites/{inviteId} {
      allow list: if isAdmin() && isEfficientQuery();

      function isAdminInvite() {
        return isAuthenticated() &&
               exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.ehAdministrador == true;
      }

      // Verifica se o usu√°rio autenticado √© o convidado
      function isConvidado() {
        return isAuthenticated() &&
               exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
               (
                 // Compara com email do token (se dispon√≠vel)
                 (request.auth.token.email != null && 
                  resource.data.emailConvidado == request.auth.token.email) ||
                 // Compara com email do documento do usu√°rio (fallback)
                 get(/databases/$(database)/documents/users/$(request.auth.uid)).data.email == resource.data.emailConvidado
               );
      }

      allow create: if isAdminInvite() &&
                       request.resource.data.convidadoPor == request.auth.uid;

      allow read: if isAdminInvite() || isConvidado();

      allow update: if isAdminInvite() ||
                       (isConvidado() &&
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status']));

      allow delete: if isAdminInvite();
    }

    // ==============================
    // üïì Cole√ß√£o: pending_edits
    // ==============================
    match /pending_edits/{edicaoId} {
      allow list: if isAuthenticated() && isEfficientQuery();
      allow read: if isAuthenticated() &&
                   (resource.data.editadoPor == request.auth.uid || isAdmin());
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // ==============================
    // üóÇÔ∏è Cole√ß√£o: edicoes_historico
    // ==============================
    match /edicoes_historico/{historicoId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if false;
    }

    // ==============================
    // üîÅ Cole√ß√£o: duplicates
    // ==============================
    match /duplicates/{duplicataId} {
      allow list: if isAdmin() && isEfficientQuery();
      allow read, update, delete: if isAdmin();
      allow create: if isAuthenticated(); // app/sistema cria
    }

    // ==============================
    // üì¨ Cole√ß√£o: recados
    // ==============================
    match /recados/{recadoId} {
      allow list: if isAuthenticated() && isEfficientQuery();
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      
      // Helper function: verifica se √© apenas atualiza√ß√£o de curtida (apoio familiar)
      function isApenasCurtida() {
        return request.resource.data.diff(resource.data).affectedKeys().hasOnly(['apoiosFamiliares', 'atualizadoEm']);
      }
      
      // Helper function: verifica se o usu√°rio √© o autor do recado
      function isAutorRecado() {
        return isAuthenticated() && resource.data.autorId == request.auth.uid;
      }
      
      // UPDATE: 
      // - Qualquer usu√°rio autenticado pode curtir/descurtir (atualizar apenas apoiosFamiliares e atualizadoEm)
      // - Autor pode atualizar qualquer campo (exceto autorId)
      // - Admin pode atualizar qualquer campo
      allow update: if isAuthenticated() && (
                      // Curtida: qualquer usu√°rio pode atualizar apenas apoiosFamiliares e atualizadoEm
                      isApenasCurtida() ||
                      // Autor pode atualizar qualquer campo (mas n√£o pode mudar autorId)
                      (isAutorRecado() && 
                       request.resource.data.autorId == resource.data.autorId) ||
                      // Admin pode atualizar qualquer campo
                      isAdmin()
                    );
      
      allow delete: if isAuthenticated() &&
                     (resource.data.autorId == request.auth.uid || isAdmin());
    }

    // ==============================
    // üí¨ Cole√ß√£o: mensagens_chat
    // ==============================
    match /mensagens_chat/{mensagemId} {
      // Para queries (list): permite queries eficientes (limit <= 100 e orderBy)
      // IMPORTANTE: A seguran√ßa √© garantida pela regra 'allow read' abaixo,
      // que valida individualmente cada documento retornado
      allow list: if isAuthenticated() && 
                     request.query.limit <= 100 &&
                     request.query.orderBy.size() > 0;

      // Para leitura individual de documentos: valida que o usu√°rio √© participante
      // CR√çTICO: Esta regra garante que mesmo se a query list passar,
      // apenas documentos onde o usu√°rio √© participante ser√£o retornados
      allow read: if isAuthenticated() &&
                   (resource.data.remetenteId == request.auth.uid ||
                    resource.data.destinatarioId == request.auth.uid);
      
      // Criar mensagem: usu√°rio autenticado pode criar mensagens onde ele √© o remetente
      allow create: if isAuthenticated() &&
                      request.resource.data.remetenteId == request.auth.uid &&
                      request.resource.data.texto is string &&
                      request.resource.data.texto.size() > 0 &&
                      request.resource.data.enviadoEm is timestamp &&
                      request.resource.data.remetenteNome is string &&
                      request.resource.data.destinatarioId is string &&
                      request.resource.data.destinatarioNome is string &&
                      request.resource.data.lida is bool;
      
      // Atualizar: apenas destinat√°rio pode marcar como lida
      allow update: if isAuthenticated() &&
                     resource.data.destinatarioId == request.auth.uid &&
                     request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lida']) &&
                     request.resource.data.lida == true;
      
      // Deletar: qualquer participante (remetente ou destinat√°rio) pode deletar mensagens
      // Permite que usu√°rios removam mensagens recebidas ou enviadas de suas conversas
      allow delete: if isAuthenticated() &&
                     (resource.data.remetenteId == request.auth.uid ||
                      resource.data.destinatarioId == request.auth.uid);
    }

    // ==============================
    // üèÜ Cole√ß√£o: conquistasDisponiveis (P√öBLICA)
    // ==============================
    match /conquistasDisponiveis/{conquistaId} {
      // LEITURA: Qualquer usu√°rio autenticado pode ver conquistas dispon√≠veis
      allow read: if isAuthenticated();
      
      // ESCRITA: Apenas admins (via Admin SDK ou Cloud Function)
      // Usu√°rios normais N√ÉO podem modificar conquistas dispon√≠veis
      allow write: if false;
    }

    // ==============================
    // üèÜ Subcole√ß√£o: conquistasProgresso (PRIVADA)
    // usuarios/{userId}/conquistasProgresso/{conquistaId}
    // ==============================
    match /usuarios/{userId}/conquistasProgresso/{conquistaId} {
      // LEITURA: Apenas o pr√≥prio usu√°rio pode ver seu progresso
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // CRIA√á√ÉO: Apenas o pr√≥prio usu√°rio pode criar progresso
      allow create: if isAuthenticated() && 
                     request.auth.uid == userId &&
                     validarProgressoConquista();
      
      // ATUALIZA√á√ÉO: Apenas o pr√≥prio usu√°rio pode atualizar seu progresso
      // Permite usar .set() que cria ou atualiza
      allow update: if isAuthenticated() && 
                     request.auth.uid == userId &&
                     validarProgressoConquista();
      
      // DELE√á√ÉO: Apenas o pr√≥prio usu√°rio pode deletar seu progresso
      allow delete: if isAuthenticated() && request.auth.uid == userId;
      
      // Fun√ß√£o auxiliar para validar dados de progresso (usada tanto em create quanto update)
      function validarProgressoConquista() {
        let dados = request.resource.data;
        // Validar campos obrigat√≥rios
        return dados.keys().hasAll(['conquistaId', 'progresso', 'concluida', 'progressoTotal']) &&
               // Validar tipos b√°sicos
               dados.conquistaId is string &&
               dados.conquistaId.size() > 0 &&
               dados.progresso is int &&
               dados.progressoTotal is int &&
               dados.concluida is bool &&
               // Progresso deve ser >= 0 e <= progressoTotal
               dados.progresso >= 0 &&
               dados.progresso <= dados.progressoTotal &&
               // progressoTotal deve ser > 0
               dados.progressoTotal > 0 &&
               // Se conclu√≠da, desbloqueadaEm deve estar presente e ser um timestamp v√°lido
               // Se n√£o conclu√≠da, desbloqueadaEm pode n√£o estar presente ou ser null
               (!dados.concluida || (dados.keys().hasAny(['desbloqueadaEm']) && dados.desbloqueadaEm != null && dados.desbloqueadaEm is timestamp)) &&
               // nivel deve ser >= 1 (se presente)
               (!dados.keys().hasAny(['nivel']) || (dados.nivel is int && dados.nivel >= 1)) &&
               // pontuacaoTotal deve ser >= 0 (se presente)
               (!dados.keys().hasAny(['pontuacaoTotal']) || (dados.pontuacaoTotal is int && dados.pontuacaoTotal >= 0)) &&
               // desbloqueadaEm pode n√£o estar presente, ser null ou ser timestamp
               (!dados.keys().hasAny(['desbloqueadaEm']) || dados.desbloqueadaEm == null || dados.desbloqueadaEm is timestamp);
      }
    }

    // ==============================
    // üèÜ Subcole√ß√£o: conquistas (DEPRECATED - Mantido para compatibilidade)
    // users/{userId}/conquistas/{conquistaId}
    // ==============================
    match /users/{userId}/conquistas/{conquistaId} {
      // Mantido apenas para leitura durante migra√ß√£o
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // Bloqueado para escrita - usar nova estrutura
      allow write: if false;
    }

    // ==============================
    // üéÆ Subcole√ß√£o: perfilGamificacao (PRIVADA)
    // usuarios/{userId}/perfilGamificacao/perfil
    // ==============================
    match /usuarios/{userId}/perfilGamificacao/{documentId} {
      // LEITURA:
      // - Documento "perfil" √© p√∫blico para usu√°rios autenticados (ranking colaborativo)
      // - Demais documentos permanecem restritos ao dono
      allow read: if isAuthenticated() &&
                   (
                     documentId == "perfil" ||
                     request.auth.uid == userId
                   );
      
      // LISTAGEM: somente para documento "perfil" com queries eficientes
      allow list: if isAuthenticated() &&
                    request.query.limit <= 100 &&
                    request.query.orderBy.size() > 0;
      
      // CRIA√á√ÉO: Apenas o pr√≥prio usu√°rio pode criar seu perfil
      allow create: if isAuthenticated() && 
                     request.auth.uid == userId &&
                     validarPerfilGamificacao();
      
      // ATUALIZA√á√ÉO: Apenas o pr√≥prio usu√°rio pode atualizar seu perfil
      allow update: if isAuthenticated() && 
                     request.auth.uid == userId &&
                     validarPerfilGamificacao();
      
      // DELE√á√ÉO: Apenas o pr√≥prio usu√°rio pode deletar seu perfil
      allow delete: if isAuthenticated() && request.auth.uid == userId;
      
      // Fun√ß√£o auxiliar para validar dados de perfil de gamifica√ß√£o
      function validarPerfilGamificacao() {
        let dados = request.resource.data;
        return dados.keys().hasAll(['nivel', 'xpTotal', 'xpAtual', 'xpProximoNivel', 'conquistasDesbloqueadas', 'totalConquistas']) &&
               // Validar tipos e valores
               dados.nivel is int &&
               dados.nivel >= 1 &&
               dados.xpTotal is int &&
               dados.xpTotal >= 0 &&
               dados.xpAtual is int &&
               dados.xpAtual >= 0 &&
               dados.xpProximoNivel is int &&
               dados.xpProximoNivel > 0 &&
               dados.conquistasDesbloqueadas is int &&
               dados.conquistasDesbloqueadas >= 0 &&
               dados.totalConquistas is int &&
               dados.totalConquistas >= 0 &&
               (!dados.keys().hasAny(['atualizadoEm']) || dados.atualizadoEm is timestamp);
      }
    }

    // ==============================
    // üì∏ Cole√ß√£o: fotos_album (FOTOS DO √ÅLBUM DE FAM√çLIA)
    // ==============================
    // √ÅLBUM COLABORATIVO (Rede Social):
    // - TODOS os usu√°rios autenticados podem ver TODAS as fotos do √°lbum
    // - A hierarquia familiar √© respeitada atrav√©s do familiaId nas fotos
    // - Permiss√µes diferenciadas por role (Admin pode tudo, usu√°rios podem interagir)
    match /fotos_album/{fotoId} {
      // LEITURA E LISTAGEM: TODOS os usu√°rios autenticados podem ver todas as fotos
      // N√£o h√° restri√ß√£o de hierarquia - app colaborativo permite acesso global
      // A hierarquia √© respeitada atrav√©s do familiaId armazenado nas fotos
      allow read, list: if isAuthenticated();
      
      // CRIA√á√ÉO: TODOS os usu√°rios autenticados podem criar fotos (app colaborativo)
      allow create: if isAuthenticated() &&
                     validarFotoAlbumCriacao();
      
      // ATUALIZA√á√ÉO: 
      // - TODOS os usu√°rios autenticados: podem dar apoio (atualizar campo apoios)
      // - ADMIN e ADMIN SR: podem atualizar tudo (descricao, ordem, apoios)
      allow update: if isAuthenticated() &&
                     (isAdmin() || isApenasAtualizacaoApoios()) &&
                     validarFotoAlbumAtualizacao();
      
      // DELE√á√ÉO: TODOS os usu√°rios autenticados podem deletar fotos (app colaborativo)
      allow delete: if isAuthenticated();
      
      // Fun√ß√£o auxiliar: verifica se √© apenas atualiza√ß√£o de apoios
      // Quando um apoio √© adicionado/removido, apenas o campo 'apoios' (ou subcampos como 'apoios.$usuarioId') √© alterado
      function isApenasAtualizacaoApoios() {
        let camposAlterados = request.resource.data.diff(resource.data).affectedKeys();
        // Verifica se apenas o campo 'apoios' foi alterado
        // Permite atualiza√ß√µes que afetam apenas o campo apoios (incluindo campos aninhados como apoios.$usuarioId)
        return camposAlterados.hasOnly(['apoios']);
      }
      
      // Fun√ß√£o auxiliar para validar dados de foto do √°lbum na cria√ß√£o
      function validarFotoAlbumCriacao() {
        let dados = request.resource.data;
        return dados.keys().hasAll(['familiaId', 'pessoaId', 'pessoaNome', 'url', 'criadoPor', 'criadoEm']) &&
               dados.familiaId is string &&
               dados.familiaId.size() > 0 &&
               dados.pessoaId is string &&
               dados.pessoaId.size() > 0 &&
               dados.pessoaNome is string &&
               dados.pessoaNome.size() > 0 &&
               dados.url is string &&
               dados.url.size() > 0 &&
               dados.criadoPor is string &&
               dados.criadoPor == request.auth.uid &&
               dados.criadoEm is timestamp &&
               // Campos opcionais: descricao pode ser string (incluindo vazia) ou null
               (!dados.keys().hasAny(['descricao']) || dados.descricao == null || dados.descricao is string) &&
               // ordem pode ser int (incluindo 0) ou null
               (!dados.keys().hasAny(['ordem']) || dados.ordem == null || dados.ordem is int);
      }
      
      // Fun√ß√£o auxiliar para validar dados de foto do √°lbum na atualiza√ß√£o
      // Permite atualizar apenas campos edit√°veis (descricao, ordem, apoios)
      // Impede altera√ß√£o de campos cr√≠ticos (familiaId, pessoaId, pessoaNome, url, criadoPor, criadoEm)
      function validarFotoAlbumAtualizacao() {
        let dados = request.resource.data;
        let dadosAntigos = resource.data;
        
        // Campos cr√≠ticos n√£o podem ser alterados
        let camposCriticosOk = dados.familiaId == dadosAntigos.familiaId &&
                               dados.pessoaId == dadosAntigos.pessoaId &&
                               dados.pessoaNome == dadosAntigos.pessoaNome &&
                               dados.url == dadosAntigos.url &&
                               dados.criadoPor == dadosAntigos.criadoPor &&
                               dados.criadoEm == dadosAntigos.criadoEm;
        
        // Validar apoios: deve ser um map onde cada valor √© uma string (nome do enum)
        let apoiosOk = !dados.keys().hasAny(['apoios']) || 
                      (dados.apoios is map);
        
        // Se for apenas atualiza√ß√£o de apoios (qualquer usu√°rio), validar apenas apoios
        // Se for ADMIN, validar tamb√©m descricao e ordem
        // Usar express√£o booleana direta ao inv√©s de vari√°vel intermedi√°ria
        let apenasApoios = isApenasAtualizacaoApoios();
        let descricaoOk = apenasApoios || 
                         (!dados.keys().hasAny(['descricao']) || 
                          dados.descricao == null || 
                          dados.descricao is string);
        
        let ordemOk = apenasApoios || 
                     (!dados.keys().hasAny(['ordem']) || 
                      dados.ordem == null || 
                      dados.ordem is int);
        
        return camposCriticosOk && descricaoOk && ordemOk && apoiosOk;
      }
      
      // ==============================
      // üí¨ Subcole√ß√£o: comentarios (COMENT√ÅRIOS DE FOTOS)
      // fotos_album/{fotoId}/comentarios/{comentarioId}
      // ==============================
      // COMENT√ÅRIOS COLABORATIVOS:
      // - TODOS os usu√°rios autenticados podem ver TODOS os coment√°rios
      // - TODOS os usu√°rios autenticados podem comentar em qualquer foto
      // - Cada usu√°rio pode excluir apenas seus pr√≥prios coment√°rios
      match /comentarios/{comentarioId} {
        // LEITURA E LISTAGEM: TODOS os usu√°rios autenticados podem ver todos os coment√°rios
        // N√£o h√° restri√ß√£o de hierarquia - app colaborativo permite acesso global
        allow read, list: if isAuthenticated();
        
        // CRIA√á√ÉO: TODOS os usu√°rios autenticados podem comentar em qualquer foto
        allow create: if isAuthenticated() &&
                       validarComentarioFoto();
        
        // ATUALIZA√á√ÉO: 
        // - ADMIN e ADMIN SR: podem atualizar qualquer coment√°rio
        // - QUALQUER usu√°rio autenticado: pode deletar apenas seus pr√≥prios coment√°rios (soft delete)
        allow update: if isAuthenticated() &&
                       (isAdmin() || isAutorComentario()) &&
                       validarComentarioFotoAtualizacao();
        
        // DELE√á√ÉO: Apenas ADMIN e ADMIN SR podem deletar fisicamente coment√°rios
        allow delete: if isAdmin();
        
        // Fun√ß√£o auxiliar: verifica se o usu√°rio √© o autor do coment√°rio
        function isAutorComentario() {
          return resource.data.usuarioId == request.auth.uid;
        }
        
        // Fun√ß√£o auxiliar para validar dados de coment√°rio na cria√ß√£o
        function validarComentarioFoto() {
          let dados = request.resource.data;
          return dados.keys().hasAll(['fotoId', 'usuarioId', 'usuarioNome', 'texto', 'criadoEm', 'deletado']) &&
                 dados.fotoId is string &&
                 dados.fotoId.size() > 0 &&
                 dados.usuarioId is string &&
                 dados.usuarioId == request.auth.uid &&
                 dados.usuarioNome is string &&
                 dados.usuarioNome.size() > 0 &&
                 dados.texto is string &&
                 dados.texto.size() > 0 &&
                 dados.texto.size() <= 500 &&
                 dados.criadoEm is timestamp &&
                 dados.deletado is bool &&
                 (!dados.keys().hasAny(['usuarioFotoUrl']) || dados.usuarioFotoUrl == null || dados.usuarioFotoUrl is string);
        }
        
        // Fun√ß√£o auxiliar para validar dados de coment√°rio na atualiza√ß√£o
        function validarComentarioFotoAtualizacao() {
          let dados = request.resource.data;
          let dadosAntigos = resource.data;
          let camposAlterados = dados.diff(dadosAntigos).affectedKeys();
          
          // Campos cr√≠ticos n√£o podem ser alterados
          let camposCriticosOk = dados.fotoId == dadosAntigos.fotoId &&
                                 dados.usuarioId == dadosAntigos.usuarioId &&
                                 dados.usuarioNome == dadosAntigos.usuarioNome &&
                                 dados.criadoEm == dadosAntigos.criadoEm;
          
          // Se for apenas soft delete (apenas campo deletado alterado), permitir
          let apenasSoftDelete = camposAlterados.hasOnly(['deletado']) &&
                                 dados.deletado is bool;
          
          // Se for admin, pode atualizar texto e deletado
          let adminPodeAtualizar = isAdmin() &&
                                   // Campos cr√≠ticos ok
                                   camposCriticosOk &&
                                   // Texto v√°lido se presente
                                   (!camposAlterados.hasAny(['texto']) ||
                                    (dados.texto is string &&
                                     dados.texto.size() > 0 &&
                                     dados.texto.size() <= 500)) &&
                                   // deletado v√°lido se presente
                                   (!camposAlterados.hasAny(['deletado']) ||
                                    dados.deletado is bool) &&
                                   // usuarioFotoUrl n√£o alterado ou v√°lido
                                   (!camposAlterados.hasAny(['usuarioFotoUrl']) ||
                                    dados.usuarioFotoUrl == dadosAntigos.usuarioFotoUrl ||
                                    dados.usuarioFotoUrl == null ||
                                    dados.usuarioFotoUrl is string);
          
          // Se for autor (QUALQUER usu√°rio autenticado), pode apenas fazer soft delete do pr√≥prio coment√°rio
          let autorPodeSoftDelete = isAutorComentario() &&
                                    apenasSoftDelete &&
                                    camposCriticosOk &&
                                    // usuarioFotoUrl n√£o alterado
                                    (!camposAlterados.hasAny(['usuarioFotoUrl']) ||
                                     dados.usuarioFotoUrl == dadosAntigos.usuarioFotoUrl);
          
          return adminPodeAtualizar || autorPodeSoftDelete;
        }
      }
    }

    // ==============================
    // üîî Subcole√ß√£o: notificacoes (PRIVADA)
    // usuarios/{userId}/notificacoes/{notificacaoId}
    // ==============================
    match /usuarios/{userId}/notificacoes/{notificacaoId} {
      // LEITURA: 
      // - Usu√°rio pode ler suas pr√≥prias notifica√ß√µes
      // - ADMIN SR pode ler notifica√ß√µes de qualquer usu√°rio (para gerenciamento)
      allow read: if isAuthenticated() &&
                   (request.auth.uid == userId || isAdminSenior());
      
      // LISTAGEM: queries eficientes com ordena√ß√£o
      allow list: if isAuthenticated() &&
                    (request.auth.uid == userId || isAdminSenior()) &&
                    request.query.limit <= 100 &&
                    request.query.orderBy.size() > 0;
      
      // CRIA√á√ÉO:
      // - ADMIN SR pode criar notifica√ß√µes para qualquer usu√°rio (mensagens globais)
      // - Sistema pode criar notifica√ß√µes para o pr√≥prio usu√°rio
      allow create: if isAuthenticated() &&
                     (
                       (isAdminSenior() && validarNotificacao()) ||
                       (request.auth.uid == userId && validarNotificacao())
                     );
      
      // ATUALIZA√á√ÉO:
      // - Usu√°rio pode atualizar suas pr√≥prias notifica√ß√µes (marcar como lida)
      // - ADMIN SR pode atualizar notifica√ß√µes de qualquer usu√°rio
      allow update: if isAuthenticated() &&
                     (
                       (request.auth.uid == userId && 
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lida']) &&
                        request.resource.data.lida is bool) ||
                       (isAdminSenior() && validarNotificacao())
                     );
      
      // DELE√á√ÉO: Apenas o pr√≥prio usu√°rio ou ADMIN SR pode deletar
      allow delete: if isAuthenticated() &&
                     (request.auth.uid == userId || isAdminSenior());
      
      // Fun√ß√£o auxiliar para validar dados de notifica√ß√£o
      function validarNotificacao() {
        let dados = request.resource.data;
        return dados.keys().hasAll(['id', 'tipo', 'titulo', 'mensagem', 'lida', 'criadaEm']) &&
               dados.id is string &&
               dados.id.size() > 0 &&
               dados.tipo is string &&
               dados.tipo.size() > 0 &&
               dados.titulo is string &&
               dados.titulo.size() > 0 &&
               dados.mensagem is string &&
               dados.mensagem.size() > 0 &&
               dados.lida is bool &&
               dados.criadaEm is timestamp &&
               // relacionadoId √© opcional (pode ser null, string vazia ou string)
               (!dados.keys().hasAny(['relacionadoId']) || 
                dados.relacionadoId == null || 
                dados.relacionadoId == "" ||
                dados.relacionadoId is string) &&
               // dadosExtras √© opcional (pode n√£o existir, ser map vazio ou map com dados)
               (!dados.keys().hasAny(['dadosExtras']) || 
                dados.dadosExtras == null ||
                dados.dadosExtras is map);
      }
    }

    // ==============================
    // üë• Cole√ß√£o: amigos (AMIGOS DA FAM√çLIA)
    // ==============================
    // COLABORATIVO:
    // - TODOS os usu√°rios autenticados podem ver TODOS os amigos
    // - TODOS os usu√°rios autenticados podem criar, editar e excluir amigos
    // - N√£o h√° restri√ß√µes de administrador - qualquer usu√°rio cadastrado tem acesso total
    match /amigos/{amigoId} {
      // LEITURA E LISTAGEM: TODOS os usu√°rios autenticados podem ver todos os amigos
      // N√£o h√° restri√ß√£o de hierarquia - app colaborativo permite acesso global
      allow read, list: if isAuthenticated() && isEfficientQuery();
      
      // CRIA√á√ÉO: Qualquer usu√°rio autenticado pode criar amigos
      allow create: if isAuthenticated() &&
                     validarAmigoCriacao();
      
      // ATUALIZA√á√ÉO: Qualquer usu√°rio autenticado pode atualizar qualquer amigo
      allow update: if isAuthenticated() &&
                     validarAmigoAtualizacao();
      
      // DELE√á√ÉO: Qualquer usu√°rio autenticado pode deletar qualquer amigo
      allow delete: if isAuthenticated();
      
      // Fun√ß√£o auxiliar para validar dados de amigo na cria√ß√£o
      function validarAmigoCriacao() {
        let dados = request.resource.data;
        return dados.keys().hasAll(['nome', 'criadoPor', 'criadoEm', 'modificadoEm']) &&
               dados.nome is string &&
               dados.nome.size() > 0 &&
               dados.criadoPor is string &&
               dados.criadoPor == request.auth.uid &&
               dados.criadoEm is timestamp &&
               dados.modificadoEm is timestamp &&
               // Campos opcionais
               (!dados.keys().hasAny(['telefone']) || dados.telefone == null || dados.telefone is string) &&
               (!dados.keys().hasAny(['familiaresVinculados']) || 
                dados.familiaresVinculados is list);
      }
      
      // Fun√ß√£o auxiliar para validar dados de amigo na atualiza√ß√£o
      function validarAmigoAtualizacao() {
        let dados = request.resource.data;
        let dadosAntigos = resource.data;
        
        // Campos cr√≠ticos n√£o podem ser alterados
        let camposCriticosOk = dados.criadoPor == dadosAntigos.criadoPor &&
                              dados.criadoEm == dadosAntigos.criadoEm;
        
        // Validar campos edit√°veis
        let nomeOk = dados.nome is string &&
                    dados.nome.size() > 0;
        
        let telefoneOk = !dados.keys().hasAny(['telefone']) ||
                        dados.telefone == null ||
                        dados.telefone is string;
        
        let familiaresVinculadosOk = !dados.keys().hasAny(['familiaresVinculados']) ||
                                    dados.familiaresVinculados is list;
        
        let modificadoEmOk = dados.modificadoEm is timestamp;
        
        return camposCriticosOk && nomeOk && telefoneOk && familiaresVinculadosOk && modificadoEmOk;
      }
    }

    // ==============================
    // üö´ Cole√ß√£o: familias_excluidas (BLACKLIST DE FAM√çLIAS DELETADAS)
    // ==============================
    // LEITURA: Todos os usu√°rios autenticados (necess√°rio para filtragem no app)
    // ESCRITA: Apenas ADMIN SR (apenas eles podem deletar fam√≠lias)
    // - Esta cole√ß√£o armazena IDs de fam√≠lias exclu√≠das para prevenir recria√ß√£o autom√°tica
    match /familias_excluidas/{familiaExcluidaId} {
      // LEITURA E LISTAGEM: Todos os usu√°rios autenticados podem ler a blacklist
      // Isso √© necess√°rio para que o app possa filtrar fam√≠lias deletadas na UI
      allow read, list: if isAuthenticated();
      
      // CRIA√á√ÉO: Apenas ADMIN SR pode adicionar √† blacklist
      allow create: if isAdminSenior() &&
                     validarFamiliaExcluidaCriacao();
      
      // ATUALIZA√á√ÉO: Apenas ADMIN SR pode atualizar
      allow update: if isAdminSenior() &&
                     validarFamiliaExcluidaAtualizacao();
      
      // DELE√á√ÉO: Apenas ADMIN SR pode remover da blacklist
      allow delete: if isAdminSenior();
      
      // Fun√ß√£o auxiliar para validar dados de fam√≠lia exclu√≠da na cria√ß√£o
      function validarFamiliaExcluidaCriacao() {
        let dados = request.resource.data;
        return dados.keys().hasAll(['familiaId', 'excluidoPor', 'excluidoEm']) &&
               dados.familiaId is string &&
               dados.familiaId.size() > 0 &&
               dados.excluidoPor is string &&
               dados.excluidoPor == request.auth.uid &&
               dados.excluidoEm is timestamp &&
               // Campos opcionais
               (!dados.keys().hasAny(['motivo']) || dados.motivo == null || dados.motivo is string) &&
               (!dados.keys().hasAny(['sincronizadoEm']) || dados.sincronizadoEm == null || dados.sincronizadoEm is timestamp) &&
               (!dados.keys().hasAny(['precisaSincronizar']) || dados.precisaSincronizar is bool);
      }
      
      // Fun√ß√£o auxiliar para validar dados de fam√≠lia exclu√≠da na atualiza√ß√£o
      function validarFamiliaExcluidaAtualizacao() {
        let dados = request.resource.data;
        let dadosAntigos = resource.data;
        
        // Campos cr√≠ticos n√£o podem ser alterados
        let camposCriticosOk = dados.familiaId == dadosAntigos.familiaId &&
                              dados.excluidoPor == dadosAntigos.excluidoPor &&
                              dados.excluidoEm == dadosAntigos.excluidoEm;
        
        // Validar campos edit√°veis (sincroniza√ß√£o)
        let sincronizacaoOk = (!dados.keys().hasAny(['sincronizadoEm']) || 
                              dados.sincronizadoEm == null || 
                              dados.sincronizadoEm is timestamp) &&
                             (!dados.keys().hasAny(['precisaSincronizar']) || 
                              dados.precisaSincronizar is bool);
        
        let motivoOk = !dados.keys().hasAny(['motivo']) || 
                      dados.motivo == null || 
                      dados.motivo is string;
        
        return camposCriticosOk && sincronizacaoOk && motivoOk;
      }
    }
  }
}
