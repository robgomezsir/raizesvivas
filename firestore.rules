rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ==============================
    // üîß Fun√ß√µes auxiliares
    // ==============================

    // Garante que o usu√°rio est√° autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // Verifica se o usu√°rio √© administrador
    function isAdmin() {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.ehAdministrador == true;
    }

    // Verifica se o usu√°rio √© o dono de um documento
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Valida documento de fam√≠lia personalizada (mantida do original)
    function isValidFamiliaPersonalizada(data, familiaId) {
      return data.keys().hasOnly([
               'familiaId',
               'nome',
               'conjuguePrincipalId',
               'conjugueSecundarioId',
               'ehFamiliaZero',
               'atualizadoPor',
               'atualizadoEm'
             ]) &&
             data.familiaId == familiaId &&
             data.nome is string &&
             data.nome.size() > 0 &&
             data.ehFamiliaZero is bool &&
             (!data.keys().hasAny(['conjuguePrincipalId']) || data.conjuguePrincipalId == null || data.conjuguePrincipalId is string) &&
             (!data.keys().hasAny(['conjugueSecundarioId']) || data.conjugueSecundarioId == null || data.conjugueSecundarioId is string) &&
             (!data.keys().hasAny(['atualizadoPor']) || data.atualizadoPor == null || data.atualizadoPor is string) &&
             data.atualizadoEm is timestamp;
    }

    // üîí Fun√ß√£o para limitar consultas grandes e sem ordena√ß√£o
    // Evita que usu√°rios fa√ßam queries sem filtro ou que tragam milhares de documentos
    // Economiza custos e melhora performance
    function isEfficientQuery() {
      return (request.query.limit <= 100) && (request.query.orderBy.size() > 0);
    }

    // ==============================
    // üë§ Cole√ß√£o: users
    // ==============================
    match /users/{userId} {
      allow read: if isAuthenticated(); // todos podem ver perfis (mantido)
      allow create, update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // ==============================
    // üßç Cole√ß√£o: people
    // ==============================
    match /people/{pessoaId} {
      allow list: if isAuthenticated() && isEfficientQuery(); // üîπ impede listagens amplas
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                     request.resource.data.keys().hasAll(['nome', 'criadoPor', 'criadoEm']);
      allow update: if isAuthenticated() &&
                     (isAdmin() ||
                      request.resource.data.criadoPor == request.auth.uid ||
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.pessoaVinculada == pessoaId);
      allow delete: if isAdmin();
    }

    // ==============================
    // üë™ Cole√ß√£o: familia_zero
    // ==============================
    match /familia_zero/{familiaId} {
      allow list: if isAuthenticated() && isEfficientQuery();
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                     request.resource.data.fundadoPor == request.auth.uid &&
                     request.resource.data.locked == true;
      allow update, delete: if isAdmin();
    }

    // ==============================
    // üß¨ Cole√ß√£o: familias_personalizadas
    // ==============================
    match /familias_personalizadas/{familiaId} {
      allow list: if isAdmin() && isEfficientQuery();
      allow read: if isAuthenticated();
      allow create, update: if isAdmin() &&
                             isValidFamiliaPersonalizada(request.resource.data, familiaId);
      allow delete: if isAdmin();
    }

    // ==============================
    // ‚úâÔ∏è Cole√ß√£o: invites
    // ==============================
    match /invites/{inviteId} {
      allow list: if isAdmin() && isEfficientQuery();

      function isAdminInvite() {
        return isAuthenticated() &&
               exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.ehAdministrador == true;
      }

      allow create: if isAdminInvite() &&
                       request.resource.data.convidadoPor == request.auth.uid;

      allow read: if isAdminInvite() ||
                    (isAuthenticated() &&
                     request.resource.data.emailConvidado == request.auth.token.email);

      allow update: if isAdminInvite() ||
                       (isAuthenticated() &&
                        resource.data.emailConvidado == request.auth.token.email &&
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status']));

      allow delete: if isAdminInvite();
    }

    // ==============================
    // üïì Cole√ß√£o: pending_edits
    // ==============================
    match /pending_edits/{edicaoId} {
      allow list: if isAuthenticated() && isEfficientQuery();
      allow read: if isAuthenticated() &&
                   (resource.data.editadoPor == request.auth.uid || isAdmin());
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // ==============================
    // üîÅ Cole√ß√£o: duplicates
    // ==============================
    match /duplicates/{duplicataId} {
      allow list: if isAdmin() && isEfficientQuery();
      allow read, update, delete: if isAdmin();
      allow create: if isAuthenticated(); // app/sistema cria
    }

    // ==============================
    // üì¨ Cole√ß√£o: recados
    // ==============================
    match /recados/{recadoId} {
      allow list: if isAuthenticated() && isEfficientQuery();
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() &&
                     ((resource.data.autorId == request.auth.uid &&
                       request.resource.data.autorId == resource.data.autorId) ||
                      isAdmin());
      allow delete: if isAuthenticated() &&
                     (resource.data.autorId == request.auth.uid || isAdmin());
    }

    // ==============================
    // üí¨ Cole√ß√£o: mensagens_chat
    // ==============================
    match /mensagens_chat/{mensagemId} {
      allow list: if isAuthenticated() && isEfficientQuery(); // üîπ previne queries sem limit

      function isRemetente() {
        return isAuthenticated() && resource.data.remetenteId == request.auth.uid;
      }

      function isDestinatario() {
        return isAuthenticated() && resource.data.destinatarioId == request.auth.uid;
      }

      function isParticipante() {
        return isAuthenticated() &&
          (resource.data.remetenteId == request.auth.uid ||
           resource.data.destinatarioId == request.auth.uid);
      }

      allow read: if isParticipante(); // apenas quem participa l√™
      allow create: if isAuthenticated() &&
                      request.resource.data.remetenteId == request.auth.uid &&
                      request.resource.data.texto is string &&
                      request.resource.data.texto.size() > 0 &&
                      request.resource.data.enviadoEm is timestamp;
      allow update: if isParticipante() &&
                      isDestinatario() &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lida']) &&
                      request.resource.data.lida == true;
      allow delete: if isRemetente();
    }

    // ==============================
    // üèÜ Subcole√ß√£o: conquistas
    // users/{userId}/conquistas/{conquistaId}
    // ==============================
    match /users/{userId}/conquistas/{conquistaId} {
      allow read, create, update, delete: if isAuthenticated() && request.auth.uid == userId;
    }
  }
}
