rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ==============================
    // üîß Fun√ß√µes auxiliares
    // ==============================

    // Garante que o usu√°rio est√° autenticado
    function isAuthenticated() {
      return request.auth != null;
    }

    // ==============================
    // üìä Cole√ß√£o: analytics_notificacoes
    // ==============================
    match /analytics_notificacoes/{eventId} {
      // LEITURA: Apenas ADMIN S√äNIOR pode consultar eventos (com queries eficientes)
      allow read, list: if isAdminSenior() && isEfficientQuery();

      // CRIA√á√ÉO: Qualquer usu√°rio autenticado pode registrar um evento pr√≥prio
      // (n√£o bloqueamos o campo usuarioId por compatibilidade, mas exigimos estar autenticado)
      allow create: if isAuthenticated() && validarEventoAnalytics();

      // Atualiza√ß√£o/Exclus√£o: bloqueado
      allow update, delete: if false;

      function validarEventoAnalytics() {
        let dados = request.resource.data;
        return dados.keys().hasAll(['usuarioId', 'notificacaoId', 'evento', 'criadoEm']) &&
               dados.usuarioId is string &&
               dados.usuarioId.size() > 0 &&
               dados.notificacaoId is string &&
               dados.notificacaoId.size() > 0 &&
               dados.evento is string &&
               dados.evento.size() > 0 &&
               dados.criadoEm is timestamp &&
               // extras s√£o opcionais e, se presentes, precisam ser map
               (!dados.keys().hasAny(['versao']) || dados.versao is string) &&
               (!dados.keys().hasAny(['downloadUrl']) || dados.downloadUrl is string);
      }
    }

    // Verifica se o usu√°rio √© administrador
    function isAdmin() {
      return isAuthenticated() &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.ehAdministrador == true;
    }

    // Verifica se o usu√°rio √© administrador s√™nior
    function isAdminSenior() {
      return isAuthenticated() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.ehAdministradorSenior == true;
    }

    // Verifica se o usu√°rio √© o dono de um documento
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Valida documento de fam√≠lia personalizada (mantida do original)
    function isValidFamiliaPersonalizada(data, familiaId) {
      return data.keys().hasOnly([
               'familiaId',
               'nome',
               'conjuguePrincipalId',
               'conjugueSecundarioId',
               'ehFamiliaZero',
               'atualizadoPor',
               'atualizadoEm'
             ]) &&
             data.familiaId == familiaId &&
             data.nome is string &&
             data.nome.size() > 0 &&
             data.ehFamiliaZero is bool &&
             (!data.keys().hasAny(['conjuguePrincipalId']) || data.conjuguePrincipalId == null || data.conjuguePrincipalId is string) &&
             (!data.keys().hasAny(['conjugueSecundarioId']) || data.conjugueSecundarioId == null || data.conjugueSecundarioId is string) &&
             (!data.keys().hasAny(['atualizadoPor']) || data.atualizadoPor == null || data.atualizadoPor is string) &&
             data.atualizadoEm is timestamp;
    }

    // üîí Fun√ß√£o para limitar consultas grandes e sem ordena√ß√£o
    // Evita que usu√°rios fa√ßam queries sem filtro ou que tragam milhares de documentos
    // Economiza custos e melhora performance
    function isEfficientQuery() {
      return (request.query.limit <= 100) && (request.query.orderBy.size() > 0);
    }

    // ==============================
    // üë§ Cole√ß√£o: users
    // ==============================
    match /users/{userId} {
      allow read: if isAuthenticated(); // todos podem ver perfis (mantido)
      allow create, update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // ==============================
    // üßç Cole√ß√£o: people
    // ==============================
    match /people/{pessoaId} {
      allow list: if isAuthenticated() && isEfficientQuery(); // üîπ impede listagens amplas
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                     request.resource.data.keys().hasAll(['nome', 'criadoPor', 'criadoEm']);
      allow update: if isAuthenticated() &&
                     (isAdmin() ||
                      request.resource.data.criadoPor == request.auth.uid ||
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.pessoaVinculada == pessoaId);
      allow delete: if isAdmin();
    }

    // ==============================
    // üë™ Cole√ß√£o: familia_zero
    // ==============================
    match /familia_zero/{familiaId} {
      allow list: if isAuthenticated() && isEfficientQuery();
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                     request.resource.data.fundadoPor == request.auth.uid &&
                     request.resource.data.locked == true;
      allow update, delete: if isAdmin();
    }

    // ==============================
    // üß¨ Cole√ß√£o: familias_personalizadas
    // ==============================
    match /familias_personalizadas/{familiaId} {
      allow list: if isAdmin() && isEfficientQuery();
      allow read: if isAuthenticated();
      allow create, update: if isAdmin() &&
                             isValidFamiliaPersonalizada(request.resource.data, familiaId);
      allow delete: if isAdmin();
    }

    // ==============================
    // ‚úâÔ∏è Cole√ß√£o: invites
    // ==============================
    match /invites/{inviteId} {
      allow list: if isAdmin() && isEfficientQuery();

      function isAdminInvite() {
        return isAuthenticated() &&
               exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.ehAdministrador == true;
      }

      allow create: if isAdminInvite() &&
                       request.resource.data.convidadoPor == request.auth.uid;

      allow read: if isAdminInvite() ||
                    (isAuthenticated() &&
                     request.resource.data.emailConvidado == request.auth.token.email);

      allow update: if isAdminInvite() ||
                       (isAuthenticated() &&
                        resource.data.emailConvidado == request.auth.token.email &&
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status']));

      allow delete: if isAdminInvite();
    }

    // ==============================
    // üïì Cole√ß√£o: pending_edits
    // ==============================
    match /pending_edits/{edicaoId} {
      allow list: if isAuthenticated() && isEfficientQuery();
      allow read: if isAuthenticated() &&
                   (resource.data.editadoPor == request.auth.uid || isAdmin());
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // ==============================
    // üóÇÔ∏è Cole√ß√£o: edicoes_historico
    // ==============================
    match /edicoes_historico/{historicoId} {
      allow read: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if false;
    }

    // ==============================
    // üîÅ Cole√ß√£o: duplicates
    // ==============================
    match /duplicates/{duplicataId} {
      allow list: if isAdmin() && isEfficientQuery();
      allow read, update, delete: if isAdmin();
      allow create: if isAuthenticated(); // app/sistema cria
    }

    // ==============================
    // üì¨ Cole√ß√£o: recados
    // ==============================
    match /recados/{recadoId} {
      allow list: if isAuthenticated() && isEfficientQuery();
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      
      // Helper function: verifica se √© apenas atualiza√ß√£o de curtida (apoio familiar)
      function isApenasCurtida() {
        return request.resource.data.diff(resource.data).affectedKeys().hasOnly(['apoiosFamiliares', 'atualizadoEm']);
      }
      
      // Helper function: verifica se o usu√°rio √© o autor do recado
      function isAutorRecado() {
        return isAuthenticated() && resource.data.autorId == request.auth.uid;
      }
      
      // UPDATE: 
      // - Qualquer usu√°rio autenticado pode curtir/descurtir (atualizar apenas apoiosFamiliares e atualizadoEm)
      // - Autor pode atualizar qualquer campo (exceto autorId)
      // - Admin pode atualizar qualquer campo
      allow update: if isAuthenticated() && (
                      // Curtida: qualquer usu√°rio pode atualizar apenas apoiosFamiliares e atualizadoEm
                      isApenasCurtida() ||
                      // Autor pode atualizar qualquer campo (mas n√£o pode mudar autorId)
                      (isAutorRecado() && 
                       request.resource.data.autorId == resource.data.autorId) ||
                      // Admin pode atualizar qualquer campo
                      isAdmin()
                    );
      
      allow delete: if isAuthenticated() &&
                     (resource.data.autorId == request.auth.uid || isAdmin());
    }

    // ==============================
    // üí¨ Cole√ß√£o: mensagens_chat
    // ==============================
    match /mensagens_chat/{mensagemId} {
      // Para queries (list): permite queries eficientes (limit <= 100 e orderBy)
      // IMPORTANTE: A seguran√ßa √© garantida pela regra 'allow read' abaixo,
      // que valida individualmente cada documento retornado
      allow list: if isAuthenticated() && 
                     request.query.limit <= 100 &&
                     request.query.orderBy.size() > 0;

      // Para leitura individual de documentos: valida que o usu√°rio √© participante
      // CR√çTICO: Esta regra garante que mesmo se a query list passar,
      // apenas documentos onde o usu√°rio √© participante ser√£o retornados
      allow read: if isAuthenticated() &&
                   (resource.data.remetenteId == request.auth.uid ||
                    resource.data.destinatarioId == request.auth.uid);
      
      // Criar mensagem: usu√°rio autenticado pode criar mensagens onde ele √© o remetente
      allow create: if isAuthenticated() &&
                      request.resource.data.remetenteId == request.auth.uid &&
                      request.resource.data.texto is string &&
                      request.resource.data.texto.size() > 0 &&
                      request.resource.data.enviadoEm is timestamp &&
                      request.resource.data.remetenteNome is string &&
                      request.resource.data.destinatarioId is string &&
                      request.resource.data.destinatarioNome is string &&
                      request.resource.data.lida is bool;
      
      // Atualizar: apenas destinat√°rio pode marcar como lida
      allow update: if isAuthenticated() &&
                     resource.data.destinatarioId == request.auth.uid &&
                     request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lida']) &&
                     request.resource.data.lida == true;
      
      // Deletar: qualquer participante (remetente ou destinat√°rio) pode deletar mensagens
      // Permite que usu√°rios removam mensagens recebidas ou enviadas de suas conversas
      allow delete: if isAuthenticated() &&
                     (resource.data.remetenteId == request.auth.uid ||
                      resource.data.destinatarioId == request.auth.uid);
    }

    // ==============================
    // üèÜ Cole√ß√£o: conquistasDisponiveis (P√öBLICA)
    // ==============================
    match /conquistasDisponiveis/{conquistaId} {
      // LEITURA: Qualquer usu√°rio autenticado pode ver conquistas dispon√≠veis
      allow read: if isAuthenticated();
      
      // ESCRITA: Apenas admins (via Admin SDK ou Cloud Function)
      // Usu√°rios normais N√ÉO podem modificar conquistas dispon√≠veis
      allow write: if false;
    }

    // ==============================
    // üèÜ Subcole√ß√£o: conquistasProgresso (PRIVADA)
    // usuarios/{userId}/conquistasProgresso/{conquistaId}
    // ==============================
    match /usuarios/{userId}/conquistasProgresso/{conquistaId} {
      // LEITURA: Apenas o pr√≥prio usu√°rio pode ver seu progresso
      allow read: if isAuthenticated() && request.auth.uid == userId;
      
      // CRIA√á√ÉO: Apenas o pr√≥prio usu√°rio pode criar progresso
      allow create: if isAuthenticated() && 
                     request.auth.uid == userId &&
                     validarProgressoConquista();
      
      // ATUALIZA√á√ÉO: Apenas o pr√≥prio usu√°rio pode atualizar seu progresso
      allow update: if isAuthenticated() && 
                     request.auth.uid == userId &&
                     validarProgressoConquista();
      
      // DELE√á√ÉO: Apenas o pr√≥prio usu√°rio pode deletar seu progresso
      allow delete: if isAuthenticated() && request.auth.uid == userId;
      
      // Fun√ß√£o auxiliar para validar dados de progresso
      function validarProgressoConquista() {
        let dados = request.resource.data;
        return dados.keys().hasAll(['conquistaId', 'progresso', 'concluida', 'progressoTotal']) &&
               // Progresso deve ser >= 0 e <= progressoTotal
               dados.progresso >= 0 &&
               dados.progresso <= dados.progressoTotal &&
               // progressoTotal deve ser > 0
               dados.progressoTotal > 0 &&
               // concluida deve ser boolean
               dados.concluida is bool &&
               // Se conclu√≠da, desbloqueadaEm deve estar presente e ser um timestamp v√°lido
               // Se n√£o conclu√≠da, desbloqueadaEm pode n√£o estar presente
               (!dados.concluida || (dados.keys().hasAny(['desbloqueadaEm']) && dados.desbloqueadaEm != null && dados.desbloqueadaEm is timestamp)) &&
               // nivel deve ser >= 1 (se presente)
               (!dados.keys().hasAny(['nivel']) || dados.nivel >= 1) &&
               // pontuacaoTotal deve ser >= 0 (se presente)
               (!dados.keys().hasAny(['pontuacaoTotal']) || dados.pontuacaoTotal >= 0) &&
               // Validar tipos b√°sicos
               dados.conquistaId is string &&
               dados.progresso is int &&
               dados.progressoTotal is int &&
               // desbloqueadaEm pode n√£o estar presente, ser null ou ser timestamp
               // (mas se conclu√≠da, deve estar presente e ser timestamp)
               (!dados.keys().hasAny(['desbloqueadaEm']) || dados.desbloqueadaEm == null || dados.desbloqueadaEm is timestamp);
      }
    }

    // ==============================
    // üèÜ Subcole√ß√£o: conquistas (DEPRECATED - Mantido para compatibilidade)
    // users/{userId}/conquistas/{conquistaId}
    // ==============================
    match /users/{userId}/conquistas/{conquistaId} {
      // Mantido apenas para leitura durante migra√ß√£o
      allow read: if isAuthenticated() && request.auth.uid == userId;
      // Bloqueado para escrita - usar nova estrutura
      allow write: if false;
    }

    // ==============================
    // üéÆ Subcole√ß√£o: perfilGamificacao (PRIVADA)
    // usuarios/{userId}/perfilGamificacao/perfil
    // ==============================
    match /usuarios/{userId}/perfilGamificacao/{documentId} {
      // LEITURA:
      // - Documento "perfil" √© p√∫blico para usu√°rios autenticados (ranking colaborativo)
      // - Demais documentos permanecem restritos ao dono
      allow read: if isAuthenticated() &&
                   (
                     documentId == "perfil" ||
                     request.auth.uid == userId
                   );
      
      // LISTAGEM: somente para documento "perfil" com queries eficientes
      allow list: if isAuthenticated() &&
                    request.query.limit <= 100 &&
                    request.query.orderBy.size() > 0;
      
      // CRIA√á√ÉO: Apenas o pr√≥prio usu√°rio pode criar seu perfil
      allow create: if isAuthenticated() && 
                     request.auth.uid == userId &&
                     validarPerfilGamificacao();
      
      // ATUALIZA√á√ÉO: Apenas o pr√≥prio usu√°rio pode atualizar seu perfil
      allow update: if isAuthenticated() && 
                     request.auth.uid == userId &&
                     validarPerfilGamificacao();
      
      // DELE√á√ÉO: Apenas o pr√≥prio usu√°rio pode deletar seu perfil
      allow delete: if isAuthenticated() && request.auth.uid == userId;
      
      // Fun√ß√£o auxiliar para validar dados de perfil de gamifica√ß√£o
      function validarPerfilGamificacao() {
        let dados = request.resource.data;
        return dados.keys().hasAll(['nivel', 'xpTotal', 'xpAtual', 'xpProximoNivel', 'conquistasDesbloqueadas', 'totalConquistas']) &&
               // Validar tipos e valores
               dados.nivel is int &&
               dados.nivel >= 1 &&
               dados.xpTotal is int &&
               dados.xpTotal >= 0 &&
               dados.xpAtual is int &&
               dados.xpAtual >= 0 &&
               dados.xpProximoNivel is int &&
               dados.xpProximoNivel > 0 &&
               dados.conquistasDesbloqueadas is int &&
               dados.conquistasDesbloqueadas >= 0 &&
               dados.totalConquistas is int &&
               dados.totalConquistas >= 0 &&
               (!dados.keys().hasAny(['atualizadoEm']) || dados.atualizadoEm is timestamp);
      }
    }

    // ==============================
    // üîî Subcole√ß√£o: notificacoes (PRIVADA)
    // usuarios/{userId}/notificacoes/{notificacaoId}
    // ==============================
    match /usuarios/{userId}/notificacoes/{notificacaoId} {
      // LEITURA: 
      // - Usu√°rio pode ler suas pr√≥prias notifica√ß√µes
      // - ADMIN SR pode ler notifica√ß√µes de qualquer usu√°rio (para gerenciamento)
      allow read: if isAuthenticated() &&
                   (request.auth.uid == userId || isAdminSenior());
      
      // LISTAGEM: queries eficientes com ordena√ß√£o
      allow list: if isAuthenticated() &&
                    (request.auth.uid == userId || isAdminSenior()) &&
                    request.query.limit <= 100 &&
                    request.query.orderBy.size() > 0;
      
      // CRIA√á√ÉO:
      // - ADMIN SR pode criar notifica√ß√µes para qualquer usu√°rio (mensagens globais)
      // - Sistema pode criar notifica√ß√µes para o pr√≥prio usu√°rio
      allow create: if isAuthenticated() &&
                     (
                       (isAdminSenior() && validarNotificacao()) ||
                       (request.auth.uid == userId && validarNotificacao())
                     );
      
      // ATUALIZA√á√ÉO:
      // - Usu√°rio pode atualizar suas pr√≥prias notifica√ß√µes (marcar como lida)
      // - ADMIN SR pode atualizar notifica√ß√µes de qualquer usu√°rio
      allow update: if isAuthenticated() &&
                     (
                       (request.auth.uid == userId && 
                        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['lida']) &&
                        request.resource.data.lida is bool) ||
                       (isAdminSenior() && validarNotificacao())
                     );
      
      // DELE√á√ÉO: Apenas o pr√≥prio usu√°rio ou ADMIN SR pode deletar
      allow delete: if isAuthenticated() &&
                     (request.auth.uid == userId || isAdminSenior());
      
      // Fun√ß√£o auxiliar para validar dados de notifica√ß√£o
      function validarNotificacao() {
        let dados = request.resource.data;
        return dados.keys().hasAll(['id', 'tipo', 'titulo', 'mensagem', 'lida', 'criadaEm']) &&
               dados.id is string &&
               dados.id.size() > 0 &&
               dados.tipo is string &&
               dados.tipo.size() > 0 &&
               dados.titulo is string &&
               dados.titulo.size() > 0 &&
               dados.mensagem is string &&
               dados.mensagem.size() > 0 &&
               dados.lida is bool &&
               dados.criadaEm is timestamp &&
               // relacionadoId √© opcional (pode ser null, string vazia ou string)
               (!dados.keys().hasAny(['relacionadoId']) || 
                dados.relacionadoId == null || 
                dados.relacionadoId == "" ||
                dados.relacionadoId is string) &&
               // dadosExtras √© opcional (pode n√£o existir, ser map vazio ou map com dados)
               (!dados.keys().hasAny(['dadosExtras']) || 
                dados.dadosExtras == null ||
                dados.dadosExtras is map);
      }
    }
  }
}
