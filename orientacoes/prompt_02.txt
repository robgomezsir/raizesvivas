# üìã Prompt 02 - Configura√ß√£o do Firebase

## üéØ Objetivo
Configurar Firebase Console, criar collections no Firestore, definir Security Rules e Indexes, e integrar com o app Android.

---

## üî• PARTE 1: Configurar Firebase Console

### Passo 1: Criar Projeto no Firebase

```
1. Acesse https://console.firebase.google.com/
2. Clique em "Adicionar projeto"
3. Nome do projeto: "Ra√≠zes Vivas"
4. Desabilite Google Analytics (n√£o necess√°rio no MVP)
5. Clique em "Criar projeto"
```

### Passo 2: Adicionar App Android

```
1. No console do Firebase, clique no √≠cone Android
2. Package name: com.raizesvivas.app
3. Nome do app: Ra√≠zes Vivas
4. SHA-1: (deixe em branco por enquanto)
5. Clique em "Registrar app"
6. BAIXE o arquivo google-services.json
7. Coloque o arquivo em: app/google-services.json (raiz do m√≥dulo app)
```

### Passo 3: Ativar Firebase Authentication

```
1. No console, v√° em "Authentication"
2. Clique em "Come√ßar"
3. V√° na aba "Sign-in method"
4. Ative "Email/Password"
5. N√ÉO ative "Link de email (login sem senha)" por enquanto
6. Salve
```

### Passo 4: Ativar Cloud Firestore

```
1. No console, v√° em "Firestore Database"
2. Clique em "Criar banco de dados"
3. Modo: "Iniciar em modo de produ√ß√£o"
4. Local: us-central1 (ou southamerica-east1 se dispon√≠vel)
5. Clique em "Ativar"
```

### Passo 5: Ativar Cloud Storage

```
1. No console, v√° em "Storage"
2. Clique em "Come√ßar"
3. Modo: "Iniciar em modo de produ√ß√£o"
4. Local: mesmo do Firestore
5. Clique em "Conclu√≠do"
```

---

## üóÑÔ∏è PARTE 2: Estrutura do Firestore

### Criar Collections Manualmente (via Console)

```
No Firebase Console > Firestore Database > Iniciar cole√ß√£o:

1. Collection: users
   - Deixe vazia (ser√° populada no primeiro login)

2. Collection: people
   - Deixe vazia (ser√° populada quando criar Fam√≠lia Zero)

3. Collection: familia_zero
   - Criar documento com ID: "raiz"
   - Deixe vazio por enquanto (ser√° populado no primeiro acesso)

4. Collection: invites
   - Deixe vazia

5. Collection: pending_edits
   - Deixe vazia

6. Collection: duplicates
   - Deixe vazia
```

---

## üîí PARTE 3: Security Rules do Firestore

### Copie e cole estas regras no Console Firebase:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // FUN√á√ïES AUXILIARES
    // ============================================
    
    // Verifica se o usu√°rio est√° autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verifica se o usu√°rio √© administrador
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.ehAdministrador == true;
    }
    
    // Verifica se √© o pr√≥prio usu√°rio
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Verifica se a Fam√≠lia Zero j√° foi criada
    function familiaZeroExists() {
      return exists(/databases/$(database)/documents/familia_zero/raiz);
    }
    
    // ============================================
    // REGRAS POR COLLECTION
    // ============================================
    
    // Collection: users
    match /users/{userId} {
      // Qualquer usu√°rio autenticado pode ler perfis
      allow read: if isAuthenticated();
      
      // Apenas o pr√≥prio usu√°rio pode criar seu perfil
      allow create: if isOwner(userId);
      
      // Apenas o pr√≥prio usu√°rio OU admin pode atualizar
      allow update: if isOwner(userId) || isAdmin();
      
      // Apenas admin pode deletar
      allow delete: if isAdmin();
    }
    
    // Collection: familia_zero
    match /familia_zero/{docId} {
      // Qualquer usu√°rio autenticado pode ler
      allow read: if isAuthenticated();
      
      // Apenas se N√ÉO existir ainda (primeiro usu√°rio)
      allow create: if isAuthenticated() && !familiaZeroExists();
      
      // NUNCA permitir atualiza√ß√£o ou dele√ß√£o
      allow update, delete: if false;
    }
    
    // Collection: people
    match /people/{pessoaId} {
      // Qualquer usu√°rio autenticado pode ler
      allow read: if isAuthenticated();
      
      // Qualquer usu√°rio autenticado pode criar
      allow create: if isAuthenticated();
      
      // Qualquer usu√°rio autenticado pode atualizar
      // (edi√ß√µes v√£o para pending_edits se n√£o for admin)
      allow update: if isAuthenticated();
      
      // Apenas admin pode deletar
      // E NUNCA pode deletar se ehFamiliaZero == true
      allow delete: if isAdmin() && 
                       resource.data.get('ehFamiliaZero', false) == false;
    }
    
    // Collection: invites
    match /invites/{conviteId} {
      // Qualquer usu√°rio autenticado pode ler convites
      allow read: if isAuthenticated();
      
      // Apenas admin pode criar convites
      allow create: if isAdmin();
      
      // Admin pode atualizar OU o pr√≥prio convidado pode aceitar/rejeitar
      allow update: if isAdmin() || 
                       (isAuthenticated() && 
                        request.auth.token.email == resource.data.emailConvidado);
      
      // Apenas admin pode deletar
      allow delete: if isAdmin();
    }
    
    // Collection: pending_edits
    match /pending_edits/{edicaoId} {
      // Qualquer usu√°rio autenticado pode ler
      allow read: if isAuthenticated();
      
      // Qualquer usu√°rio autenticado pode criar
      allow create: if isAuthenticated();
      
      // Apenas admin pode atualizar (aprovar/rejeitar)
      allow update: if isAdmin();
      
      // Apenas admin pode deletar
      allow delete: if isAdmin();
    }
    
    // Collection: duplicates
    match /duplicates/{duplicataId} {
      // Qualquer usu√°rio autenticado pode ler
      allow read: if isAuthenticated();
      
      // Apenas admin pode escrever
      allow write: if isAdmin();
    }
  }
}
```

### Como aplicar as regras:
```
1. No Firebase Console > Firestore Database
2. Aba "Regras"
3. Cole o c√≥digo acima
4. Clique em "Publicar"
```

---

## üìä PARTE 4: Indexes do Firestore

### Copie e cole estes indexes:

```javascript
// No Firebase Console > Firestore Database > Indexes

// Index 1: people - Para buscar pessoas aprovadas ordenadas por data
Collection: people
Fields:
  - aprovado (Ascending)
  - criadoEm (Descending)
Query scope: Collection

// Index 2: people - Para detectar duplicatas
Collection: people
Fields:
  - pai (Ascending)
  - mae (Ascending)
  - dataNascimento (Ascending)
Query scope: Collection

// Index 3: invites - Para buscar convites pendentes de um email
Collection: invites
Fields:
  - emailConvidado (Ascending)
  - status (Ascending)
Query scope: Collection

// Index 4: pending_edits - Para listar edi√ß√µes pendentes
Collection: pending_edits
Fields:
  - status (Ascending)
  - criadoEm (Descending)
Query scope: Collection

// Index 5: duplicates - Para buscar duplicatas n√£o resolvidas
Collection: duplicates
Fields:
  - resolvidoEm (Ascending)
Query scope: Collection

// Index 6: people - Para buscar por nome (case-insensitive)
Collection: people
Fields:
  - nomeNormalizado (Ascending)
  - aprovado (Ascending)
Query scope: Collection
```

### Como criar os indexes:

**OP√á√ÉO 1: Via Console (Manual)**
```
1. Firestore Database > Indexes
2. Clique em "Adicionar √≠ndice"
3. Preencha os campos conforme especificado acima
4. Repita para cada index
```

**OP√á√ÉO 2: Via CLI (Autom√°tico - RECOMENDADO)**
```
Crie um arquivo firestore.indexes.json na raiz do projeto:
```

```json
{
  "indexes": [
    {
      "collectionGroup": "people",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "aprovado", "order": "ASCENDING" },
        { "fieldPath": "criadoEm", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "people",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "pai", "order": "ASCENDING" },
        { "fieldPath": "mae", "order": "ASCENDING" },
        { "fieldPath": "dataNascimento", "order": "ASCENDING" }
      ]
    },
    {
      "collectionGroup": "invites",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "emailConvidado", "order": "ASCENDING" },
        { "fieldPath": "status", "order": "ASCENDING" }
      ]
    },
    {
      "collectionGroup": "pending_edits",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "status", "order": "ASCENDING" },
        { "fieldPath": "criadoEm", "order": "DESCENDING" }
      ]
    },
    {
      "collectionGroup": "duplicates",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "resolvidoEm", "order": "ASCENDING" }
      ]
    },
    {
      "collectionGroup": "people",
      "queryScope": "COLLECTION",
      "fields": [
        { "fieldPath": "nomeNormalizado", "order": "ASCENDING" },
        { "fieldPath": "aprovado", "order": "ASCENDING" }
      ]
    }
  ],
  "fieldOverrides": []
}
```

---

## üõ°Ô∏è PARTE 5: Storage Rules

### Configurar regras de Storage:

```javascript
rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    
    // Fun√ß√£o auxiliar
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Validar tamanho e tipo de arquivo
    function isValidImage() {
      return request.resource.size < 10 * 1024 && // M√°ximo 10KB
             request.resource.contentType.matches('image/.*');
    }
    
    // Fotos de perfil das pessoas
    match /fotos_perfil/{userId}/{fileName} {
      // Qualquer usu√°rio autenticado pode ler
      allow read: if isAuthenticated();
      
      // Apenas o pr√≥prio usu√°rio pode fazer upload
      // E deve ser uma imagem v√°lida
      allow write: if isAuthenticated() && 
                      request.auth.uid == userId &&
                      isValidImage();
    }
    
    // Fotos tempor√°rias (antes de compress√£o)
    match /temp/{userId}/{fileName} {
      allow read, write: if isAuthenticated() && 
                           request.auth.uid == userId;
      
      // Auto-dele√ß√£o ap√≥s 24 horas (configurar Cloud Function futuramente)
    }
  }
}
```

### Como aplicar:
```
1. Firebase Console > Storage
2. Aba "Rules"
3. Cole o c√≥digo acima
4. Clique em "Publicar"
```

---

## üîå PARTE 6: Integrar Firebase no C√≥digo Android

### Arquivo: di/FirebaseModule.kt

```kotlin
package com.raizesvivas.app.di

import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.firestore.FirebaseFirestore
import com.google.firebase.firestore.FirebaseFirestoreSettings
import com.google.firebase.storage.FirebaseStorage
import dagger.Module
import dagger.Provides
import dagger.hilt.InstallIn
import dagger.hilt.components.SingletonComponent
import javax.inject.Singleton

/**
 * M√≥dulo Hilt para prover inst√¢ncias do Firebase
 * 
 * Este m√≥dulo centraliza a configura√ß√£o de todas as
 * inst√¢ncias do Firebase usadas no app.
 */
@Module
@InstallIn(SingletonComponent::class)
object FirebaseModule {
    
    /**
     * Prov√™ inst√¢ncia do Firebase Authentication
     */
    @Provides
    @Singleton
    fun provideFirebaseAuth(): FirebaseAuth {
        return FirebaseAuth.getInstance().apply {
            // Configurar idioma para PT-BR
            setLanguageCode("pt-BR")
        }
    }
    
    /**
     * Prov√™ inst√¢ncia do Cloud Firestore
     */
    @Provides
    @Singleton
    fun provideFirebaseFirestore(): FirebaseFirestore {
        return FirebaseFirestore.getInstance().apply {
            // Configura√ß√µes de performance
            firestoreSettings = FirebaseFirestoreSettings.Builder()
                .setPersistenceEnabled(true) // Cache local
                .setCacheSizeBytes(FirebaseFirestoreSettings.CACHE_SIZE_UNLIMITED)
                .build()
        }
    }
    
    /**
     * Prov√™ inst√¢ncia do Firebase Storage
     */
    @Provides
    @Singleton
    fun provideFirebaseStorage(): FirebaseStorage {
        return FirebaseStorage.getInstance().apply {
            maxUploadRetryTimeMillis = 60000 // 60 segundos
        }
    }
}
```

---

### Arquivo: data/remote/firebase/AuthService.kt

```kotlin
package com.raizesvivas.app.data.remote.firebase

import com.google.firebase.auth.FirebaseAuth
import com.google.firebase.auth.FirebaseUser
import com.google.firebase.auth.UserProfileChangeRequest
import kotlinx.coroutines.tasks.await
import timber.log.Timber
import javax.inject.Inject
import javax.inject.Singleton

/**
 * Servi√ßo para gerenciar autentica√ß√£o Firebase
 * 
 * Responsabilidades:
 * - Login com email/senha
 * - Cadastro de novos usu√°rios
 * - Recupera√ß√£o de senha
 * - Logout
 * - Obter usu√°rio atual
 */
@Singleton
class AuthService @Inject constructor(
    private val firebaseAuth: FirebaseAuth
) {
    
    /**
     * Usu√°rio atualmente logado (null se n√£o estiver logado)
     */
    val currentUser: FirebaseUser?
        get() = firebaseAuth.currentUser
    
    /**
     * Verifica se h√° usu√°rio logado
     */
    val isLoggedIn: Boolean
        get() = currentUser != null
    
    /**
     * Realiza login com email e senha
     * 
     * @param email Email do usu√°rio
     * @param senha Senha do usu√°rio
     * @return Result com FirebaseUser ou erro
     */
    suspend fun login(email: String, senha: String): Result<FirebaseUser> {
        return try {
            Timber.d("üîê Tentando login: $email")
            
            val result = firebaseAuth
                .signInWithEmailAndPassword(email, senha)
                .await()
            
            val user = result.user
            
            if (user != null) {
                Timber.d("‚úÖ Login bem-sucedido: ${user.uid}")
                Result.success(user)
            } else {
                Timber.e("‚ùå Login falhou: usu√°rio nulo")
                Result.failure(Exception("Erro ao fazer login"))
            }
            
        } catch (e: Exception) {
            Timber.e(e, "‚ùå Erro no login")
            Result.failure(e)
        }
    }
    
    /**
     * Cria nova conta com email e senha
     * 
     * @param email Email do novo usu√°rio
     * @param senha Senha (m√≠nimo 8 caracteres)
     * @param nomeCompleto Nome completo para o perfil
     * @return Result com FirebaseUser ou erro
     */
    suspend fun cadastrar(
        email: String,
        senha: String,
        nomeCompleto: String
    ): Result<FirebaseUser> {
        return try {
            Timber.d("üìù Criando conta: $email")
            
            // Criar conta
            val result = firebaseAuth
                .createUserWithEmailAndPassword(email, senha)
                .await()
            
            val user = result.user
            
            if (user != null) {
                // Atualizar nome do perfil
                val profileUpdates = UserProfileChangeRequest.Builder()
                    .setDisplayName(nomeCompleto)
                    .build()
                
                user.updateProfile(profileUpdates).await()
                
                Timber.d("‚úÖ Conta criada: ${user.uid}")
                Result.success(user)
            } else {
                Timber.e("‚ùå Falha ao criar conta: usu√°rio nulo")
                Result.failure(Exception("Erro ao criar conta"))
            }
            
        } catch (e: Exception) {
            Timber.e(e, "‚ùå Erro ao criar conta")
            Result.failure(e)
        }
    }
    
    /**
     * Envia email de recupera√ß√£o de senha
     * 
     * @param email Email cadastrado
     * @return Result indicando sucesso ou erro
     */
    suspend fun recuperarSenha(email: String): Result<Unit> {
        return try {
            Timber.d("üìß Enviando email de recupera√ß√£o para: $email")
            
            firebaseAuth.sendPasswordResetEmail(email).await()
            
            Timber.d("‚úÖ Email de recupera√ß√£o enviado")
            Result.success(Unit)
            
        } catch (e: Exception) {
            Timber.e(e, "‚ùå Erro ao enviar email de recupera√ß√£o")
            Result.failure(e)
        }
    }
    
    /**
     * Faz logout do usu√°rio atual
     */
    fun logout() {
        Timber.d("üëã Fazendo logout")
        firebaseAuth.signOut()
    }
    
    /**
     * Reautentica o usu√°rio (necess√°rio para opera√ß√µes sens√≠veis)
     */
    suspend fun reautenticar(senha: String): Result<Unit> {
        return try {
            val user = currentUser ?: return Result.failure(
                Exception("Nenhum usu√°rio logado")
            )
            
            val credential = com.google.firebase.auth.EmailAuthProvider
                .getCredential(user.email!!, senha)
            
            user.reauthenticate(credential).await()
            
            Result.success(Unit)
            
        } catch (e: Exception) {
            Timber.e(e, "‚ùå Erro ao reautenticar")
            Result.failure(e)
        }
    }
}
```

---

## ‚úÖ Checklist de Verifica√ß√£o

Ap√≥s executar este prompt, verifique:

- [ ] Arquivo google-services.json est√° em app/
- [ ] Authentication est√° ativo no Firebase Console
- [ ] Firestore Database est√° criado
- [ ] Storage est√° ativo
- [ ] Security Rules foram publicadas (Firestore e Storage)
- [ ] Indexes foram criados
- [ ] C√≥digo compila sem erros
- [ ] AuthService pode ser injetado via Hilt

---

## üß™ Teste R√°pido

Para testar se o Firebase est√° configurado corretamente:

```kotlin
// Em algum ViewModel ou Activity, injete:
@Inject lateinit var authService: AuthService

// No onCreate ou init, adicione:
Timber.d("Firebase Auth est√° configurado: ${authService.isLoggedIn}")
```

---

## üîú Pr√≥ximo Passo

**Prompt 03**: Criar Models de Dom√≠nio e Entities do Room