rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    
    // Verifica se está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Valida extensão de arquivo no nome do arquivo
    function isValidImageExtension(fileName) {
      return fileName.matches('.*\\.(jpg|jpeg|png|webp)$') ||
             fileName.matches('.*\\.(JPG|JPEG|PNG|WEBP)$');
    }
    
    // Valida tipo de conteúdo MIME
    function isValidImageContentType() {
      return request.resource.contentType == "image/jpeg" ||
             request.resource.contentType == "image/jpg" ||
             request.resource.contentType == "image/png" ||
             request.resource.contentType == "image/webp";
    }
    
    // Tamanho máximo unificado: 300KB
    function isValidFileSize() {
      return request.resource.size <= 300 * 1024;
    }
    
    // PASTA: pessoas/{pessoaId}/arquivo
    match /pessoas/{pessoaId}/{fileName} {
      
      // Todos autenticados podem LER fotos de qualquer cadastro
      allow read: if isAuthenticated();
      
      // Todos autenticados podem ENVIAR ou ATUALIZAR fotos (app colaborativo)
      allow write: if isAuthenticated()
                   &&
                   // Validação de extensão no nome do arquivo
                   isValidImageExtension(fileName)
                   &&
                   // Validação de tipo de conteúdo MIME
                   isValidImageContentType()
                   &&
                   // Máximo 300 KB (unificado)
                   isValidFileSize();
    }
    
    // PASTA: album_familia/{pessoaId}/{fotoId}.jpg
    match /album_familia/{pessoaId}/{fileName} {
      
      // Todos autenticados podem LER fotos do álbum
      allow read: if isAuthenticated();
      
      // Todos autenticados podem CRIAR ou ATUALIZAR fotos do álbum (app colaborativo)
      allow create, update: if isAuthenticated()
                   &&
                   // Validação de extensão no nome do arquivo
                   isValidImageExtension(fileName)
                   &&
                   // Validação de tipo de conteúdo MIME
                   isValidImageContentType()
                   &&
                   // Máximo 300 KB (unificado)
                   isValidFileSize();
      
      // Todos autenticados podem DELETAR fotos do álbum
      allow delete: if isAuthenticated();
    }
  }
}

